<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Charts</title>
<style>
  :root{
    color-scheme: dark;
    --line:#b9d3ff;
    --text:#eaf2ff;
    --cyan:#80d7ff;
    --yellow:#ffe26b;
    --bg1:#0733a5;
    --bg2:#041f66;
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    padding:18px;
    background: linear-gradient(180deg, var(--bg1) 0%, #062a8a 55%, var(--bg2) 100%);
    color:var(--text);
    font-family:var(--sans);
  }
  .frame{
    border: 2px solid var(--line);
    background: rgba(0,0,0,.06);
    box-shadow: 0 16px 60px rgba(0,0,0,.35);
  }
  .topbar{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    padding:10px 12px;
    border-bottom: 2px solid var(--line);
    background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.02));
    font-family: var(--mono);
  }
  .title{ color: var(--yellow); font-weight:800; letter-spacing:.8px; text-transform:uppercase; }
  .pill{
    border: 1px solid var(--line);
    padding:6px 8px;
    border-radius:3px;
    background: rgba(0,0,0,.10);
    white-space:nowrap;
    color: var(--text);
    font-family: var(--mono);
    font-size: 12px;
  }
  button.pill:hover{ background: rgba(255,255,255,.08); cursor:pointer; }
  .content{ padding: 12px; }
  .error{
    display:none;
    padding:10px 12px;
    margin: 12px;
    border: 1px solid var(--line);
    background: rgba(255,92,92,.10);
    font-family: var(--mono);
    white-space: pre-wrap;
  }
  .grid{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 12px;
  }
  .card{
    border: 1px solid rgba(185,211,255,.55);
    background: rgba(0,0,0,.10);
    padding: 10px;
  }
  .card h3{
    margin: 0 0 10px 0;
    font-family: var(--mono);
    color: var(--cyan);
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: .4px;
  }
  .link{
    display:flex; justify-content:space-between; gap:10px;
    padding: 6px 0;
    border-bottom: 1px dashed rgba(185,211,255,.25);
    font-family: var(--mono);
    font-size: 12px;
  }
  .link a{
    color: var(--text);
    text-decoration: none;
  }
  .link a:hover{ text-decoration: underline; }
  .muted{ color: rgba(234,242,255,.75); font-family: var(--mono); font-size: 12px; }
</style>
</head>
<body>

<div class="frame">
  <div class="topbar">
    <div class="title" id="hdr">CHARTS</div>
    <div style="display:flex; gap:8px; align-items:center;">
      <button class="pill" onclick="history.length ? history.back() : (location.href='index.html')">BACK</button>
      <button class="pill" id="refreshBtn">REFRESH</button>
    </div>
  </div>

  <div class="error" id="errorBox"></div>

  <div class="content">
    <div class="muted" id="sub">Loading…</div>
    <div style="height:12px"></div>
    <div class="grid" id="grid"></div>
  </div>
</div>

<script>
  const API_BASE = "https://metar-proxy.chrisgut96.workers.dev"; // your worker domain

  const params = new URLSearchParams(location.search);
  const icao = (params.get("icao") || "").toUpperCase().trim();

  const hdr = document.getElementById("hdr");
  const sub = document.getElementById("sub");
  const grid = document.getElementById("grid");
  const errorBox = document.getElementById("errorBox");
  const refreshBtn = document.getElementById("refreshBtn");

  hdr.textContent = `CHARTS — ${icao || "UNKNOWN"}`;

  function showError(msg){
    errorBox.style.display = "block";
    errorBox.textContent = msg;
  }
  function clearError(){
    errorBox.style.display = "none";
    errorBox.textContent = "";
  }

  function groupByCategory(items){
    const out = { Aerodrome: [], SID: [], STAR: [], Approach: [], Other: [] };
    for (const it of items) (out[it.category] || out.Other).push(it);
    return out;
  }

  function render(groups, airportPageUrl){
    grid.innerHTML = "";

    const order = ["Aerodrome","SID","STAR","Approach","Other"];
    for (const cat of order) {
      const arr = groups[cat] || [];
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `<h3>${cat}</h3>`;
      if (!arr.length) {
        const empty = document.createElement("div");
        empty.className = "muted";
        empty.textContent = "—";
        card.appendChild(empty);
      } else {
        for (const it of arr) {
          const row = document.createElement("div");
          row.className = "link";
          row.innerHTML = `
            <a href="${it.url}" target="_blank" rel="noopener noreferrer">${it.title}</a>
            <span class="muted">DFS</span>
          `;
          card.appendChild(row);
        }
      }
      grid.appendChild(card);
    }

    sub.innerHTML = airportPageUrl
      ? `Source page: <a class="muted" href="${airportPageUrl}" target="_blank" rel="noopener noreferrer">${airportPageUrl}</a>`
      : `Source: DFS BasicIFR`;
  }

  async function load(){
    clearError();
    if (!icao) {
      showError("Missing ?icao= in URL (example: charts.html?icao=EDDH)");
      sub.textContent = "";
      return;
    }

    refreshBtn.disabled = true;
    sub.textContent = "Fetching chart permalinks from DFS…";

    try {
      const url = `${API_BASE}/aip/charts?icao=${encodeURIComponent(icao)}&_=${Date.now()}`;
      const res = await fetch(url, { cache: "no-store" });

      const txt = await res.text();
      let data;
      try { data = JSON.parse(txt); }
      catch { throw new Error("Worker did not return JSON.\n\n" + txt.slice(0, 500)); }

      if (!res.ok || !data.ok) {
        throw new Error(data?.error || `Request failed (HTTP ${res.status}).`);
      }

      const groups = groupByCategory(data.items || []);
      render(groups, data.airportPageUrl || "");
    } catch (e) {
      showError(String(e?.message || e));
      sub.textContent = "—";
      grid.innerHTML = "";
    } finally {
      refreshBtn.disabled = false;
    }
  }

  refreshBtn.addEventListener("click", load);
  load();
</script>

</body>
</html>
