<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>METAR SUED Board</title>
<style>
  :root{
    color-scheme: dark;
    --bg:#062a8a;
    --panel:#041f66;
    --panel2:#0733a5;
    --line:#b9d3ff;
    --text:#eaf2ff;
    --cyan:#80d7ff;
    --yellow:#ffe26b;
    --red:#ff5c5c;
    --green:#3dff9a;
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    padding:18px;
    background: linear-gradient(180deg,#041a55 0%,#031445 55%,#020f36 100%);
    color:var(--text);
    font-family:var(--sans);
  }

  .frame{
    border: 2px solid var(--line);
    background: rgba(0,0,0,.06);
    box-shadow: 0 16px 60px rgba(0,0,0,.35);
  }

  .topbar{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding:10px 12px;
    border-bottom: 2px solid var(--line);
    background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.02));
  }

  .title{
    font-family:var(--mono);
    font-weight:700;
    letter-spacing:.8px;
    font-size:18px;
    color:var(--yellow);
    text-transform:uppercase;
  }

  .rightInfo{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
    justify-content:flex-end;
    font-family:var(--mono);
    font-size:12px;
    color:var(--cyan);
  }

  .pill{
    border: 1px solid var(--line);
    padding:6px 8px;
    border-radius:3px;
    background: rgba(0,0,0,.10);
    white-space:nowrap;
  }

  .controls{
    display:flex;
    gap:8px;
    align-items:center;
    flex-wrap:wrap;
  }

  select, button, input[type="checkbox"]{
    font-family:var(--mono);
    font-size:12px;
  }
  select, button{
    border:1px solid var(--line);
    background: rgba(0,0,0,.10);
    color:var(--text);
    padding:6px 8px;
    border-radius:3px;
    outline:none;
  }
  button:hover{ background: rgba(255,255,255,.08); cursor:pointer; }
  button:disabled{ opacity:.55; cursor:not-allowed; }
  label{
    display:inline-flex;
    gap:6px;
    align-items:center;
    user-select:none;
  }

  .error{
    display:none;
    padding:10px 12px;
    border-bottom: 2px solid var(--line);
    background: rgba(255,92,92,.10);
    color: var(--text);
    font-family: var(--mono);
    font-size: 12px;
    white-space: pre-wrap;
  }

  .board{
    width:100%;
    border-collapse: collapse;
    table-layout: fixed;
    font-family: var(--mono);
    font-size: 13px;
  }
  .board th, .board td{
    border-bottom: 1px solid rgba(185,211,255,.55);
    padding: 8px 10px;
    vertical-align: top;
  }
  .board thead th{
    border-bottom: 2px solid var(--line);
    background: rgba(0,0,0,.12);
    color: var(--cyan);
    font-weight: 700;
    letter-spacing: .4px;
    text-transform: uppercase;
    font-size: 12px;
  }

  .col-sta{ width: 90px; }
  .col-ctr{ width: 95px; font-weight: 900; font-size: 14px; letter-spacing: 0.4px; }
  .col-rwy{ width: 120px; font-weight: 900; font-size: 16px; letter-spacing: 0.5px; }
  .col-qnh{ width: 92px; font-weight: 900; font-size: 16px; letter-spacing: 0.5px; }
  .col-wind{ width: 130px; font-weight: 900; font-size: 16px; letter-spacing: 0.6px; }
  .col-vis{ width: 90px; }
  .col-met{ width: auto; }

  .ctrlabel{ color: var(--text); font-weight: 900; }
  .ctractive{ color: var(--green); font-weight: 900; }
  .ctroff{ color: rgba(234,242,255,.55); font-weight: 700; }

  .sta{
    color: var(--cyan);
    font-weight: 900;
    font-size: 16px;
    letter-spacing: 1.2px;
    line-height: 1.1;
  }

  .muted{ color: rgba(234,242,255,.75); }
  .metar{
    white-space: pre-wrap;
    word-break: break-word;
    line-height: 1.25;
  }
  .changed{ color: var(--red); }
  .new{ color: var(--green); }

  .foot{
    padding:10px 12px;
    border-top: 2px solid var(--line);
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    justify-content:space-between;
    align-items:center;
    background: rgba(0,0,0,.10);
    font-family:var(--mono);
    font-size:12px;
    color: rgba(234,242,255,.78);
  }
</style>
</head>
<body>

<div class="frame">
  <div class="topbar">
    <div>
      <div class="title">METAR and AD-Info — EBG NORD</div>
      <div class="muted" style="font-family:var(--mono); font-size:12px; margin-top:2px;">
        ATC-style board • auto-refresh
      </div>
    </div>

    <div class="rightInfo">
      <div class="pill" id="statusPill">STATUS: <span id="statusText">IDLE</span></div>
      <div class="pill" id="timePill">UTC: <span id="utcClock">--:--:--</span></div>
      <div class="controls">

        <!-- ✅ PRESET MENU (this was missing) -->
        <select id="presetSelect" class="pill" title="Station set">
          <option value="EBG_NORD" selected>EBG NORD</option>
          <option value="EBG_SUED">EBG SUED</option>
          <option value="EDWW_WEST">EDWW WEST</option>
        </select>

        <label class="pill">
          <input type="checkbox" id="autoToggle" checked />
          AUTO
        </label>

        <select id="refreshSelect" class="pill" title="Refresh interval">
          <option value="30">30s</option>
          <option value="60" selected>60s</option>
          <option value="120">2m</option>
          <option value="300">5m</option>
        </select>

        <button id="refreshBtn" class="pill">REFRESH</button>
      </div>
    </div>
  </div>

  <div class="error" id="errorBox"></div>

  <table class="board">
    <thead>
      <tr>
        <th class="col-sta">STN</th>
        <th class="col-ctr">CTR</th>
        <th class="col-rwy">RWY</th>
        <th class="col-qnh">QNH</th>
        <th class="col-wind">WIND</th>
        <th class="col-vis">VIS</th>
        <th class="col-met">METAR</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <div class="foot">
    <div>Source: METAR proxy → <span class="muted">metar-proxy.chrisgut96.workers.dev</span></div>
    <div>Tip: hard refresh with <span class="muted">Ctrl+F5</span> after updating</div>
  </div>
</div>

<script>
  const STATION_PRESETS = {
    EBG_NORD: ["EDDH","EDHI","EDHL","EDDW","EDXW","EDDV","ETNS","ETNH","ETMN","ETNT"],
    EBG_SUED: ["EDDV","EDVE","EDVK","EDDW","EDDG","EDDP","ETNW","ETHB","ETHC","ETSH"],
    EDWW_WEST: ["EDDH","EDHI","EDHL","EDDW","EDXW","EDDV","EDVE","EDVK","EDDP"],
  };

  let STATIONS = [...STATION_PRESETS.EBG_NORD];
  const API_BASE = "https://metar-proxy.chrisgut96.workers.dev";

  const presetSelect = document.getElementById("presetSelect");
  const refreshBtn = document.getElementById("refreshBtn");
  const autoToggle = document.getElementById("autoToggle");
  const refreshSelect = document.getElementById("refreshSelect");
  const statusText = document.getElementById("statusText");
  const errorBox = document.getElementById("errorBox");
  const tbody = document.getElementById("tbody");

  const state = {
    timer: null,
    lastRaw: new Map(), // station -> rawOb
  };

  function setStatus(txt){ statusText.textContent = txt; }
  function showError(msg){
    errorBox.style.display = "block";
    errorBox.textContent = msg;
  }
  function clearError(){
    errorBox.style.display = "none";
    errorBox.textContent = "";
  }

  function pad2(n){ return String(n).padStart(2,"0"); }
  function setUtcClock(){
    const d = new Date();
    const s = `${pad2(d.getUTCHours())}:${pad2(d.getUTCMinutes())}:${pad2(d.getUTCSeconds())}`;
    document.getElementById("utcClock").textContent = s;
  }
  setInterval(setUtcClock, 500);
  setUtcClock();

  function extractRunwaysFromAtis(textLinesOrString) {
    const text = Array.isArray(textLinesOrString)
      ? textLinesOrString.join(" ")
      : String(textLinesOrString || "");
    const t = text.toUpperCase().replace(/\s+/g, " ").trim();

    const out = { arrival:new Set(), departure:new Set(), general:new Set() };
    const normRwy = (s) => String(s).toUpperCase().trim();

    for (const m of t.matchAll(/\bLDG\b(?:\s+(?:RWY|RUNWAY))?\s+(\d{1,2}[LRC]?)\b/g)) out.arrival.add(normRwy(m[1]));
    for (const m of t.matchAll(/\bTKOF\b(?:\s+(?:RWY|RUNWAY))?\s+(\d{1,2}[LRC]?)\b/g)) out.departure.add(normRwy(m[1]));
    for (const m of t.matchAll(/\b(?:ARR|ARRIVAL)\b(?:\s+(?:RWY|RUNWAY))?\s+(\d{1,2}[LRC]?)\b/g)) out.arrival.add(normRwy(m[1]));
    for (const m of t.matchAll(/\b(?:DEP|DEPARTURE)\b(?:\s+(?:RWY|RUNWAY))?\s+(\d{1,2}[LRC]?)\b/g)) out.departure.add(normRwy(m[1]));
    for (const m of t.matchAll(/\b(?:RWY|RUNWAY)\s+(\d{1,2}[LRC]?)\b/g)) out.general.add(normRwy(m[1]));

    if (out.arrival.size === 0 && out.departure.size === 0 && out.general.size > 0) {
      for (const r of out.general) { out.arrival.add(r); out.departure.add(r); }
    }

    const toSorted = (set) => [...set].sort((a,b) => a.localeCompare(b));
    return { arrival:toSorted(out.arrival), departure:toSorted(out.departure), general:toSorted(out.general) };
  }

  // ✅ RWY 23 33 (LDG first, TKOF second), else RWY 23
  function formatRunwayDisplay(r) {
    const a = r.arrival.join(" ").trim();
    const d = r.departure.join(" ").trim();
    if (a && d && a !== d) return `RWY ${a} ${d}`;
    const same = a || d;
    if (same) return `RWY ${same}`;
    if (r.general.length) return `RWY ${r.general.join(" ")}`;
    return "RWY --";
  }

  function fmtQnh(item){
    const qnh = item?.altim;
    if (qnh == null || qnh === "") return "--";
    const n = Number(qnh);
    return isNaN(n) ? `Q${String(qnh)}` : `Q${Math.round(n)}`;
  }

  function fmtWind(item){
    const raw = (item?.rawOb ?? "") || "";
    const m = raw.match(/\b((?:\d{3}|VRB))(\d{2,3})(?:G(\d{2,3}))?KT\b/i);
    if (m) {
      const dir = m[1].toUpperCase();
      const spd = parseInt(m[2], 10);
      const gst = m[3] ? parseInt(m[3], 10) : null;
      if (dir === "000" && spd === 0) return "CALM";
      const spdStr = String(spd).padStart(2, "0");
      const gstStr = gst != null ? ` G${String(gst).padStart(2, "0")}` : "";
      return (dir === "VRB") ? `VRB/${spdStr}${gstStr}` : `${dir}/${spdStr}${gstStr}`;
    }
    const dir = item?.wdir;
    const spd = item?.wspd;
    if (dir == null && spd == null) return "----";
    if (Number(spd) === 0) return "CALM";
    return `${String(Math.round(Number(dir))).padStart(3,"0")}/${String(Math.round(Number(spd))).padStart(2,"0")}`;
  }

  function fmtVis(item){
    const raw = (item?.rawOb ?? "") || "";
    if (/\bCAVOK\b/i.test(raw)) return "9999+";
    const m = raw.match(/\b\d{5}KT\s+(?:\d{3}V\d{3}\s+)?(\d{4}|9999)\b/i);
    if (m && m[1]) return (m[1] === "9999") ? "9999+" : m[1];

    const v = item?.visib;
    if (v == null || v === "") return "--";
    const miles = Number(v);
    if (isNaN(miles)) return String(v);
    const meters = Math.round(miles * 1609.34);
    if (meters >= 10000) return "9999+";
    const rounded = Math.round(meters / 50) * 50;
    return String(rounded);
  }

  function obsZFromItem(item){
    let d = null;
    if (item?.reportTime) d = new Date(item.reportTime);
    else if (item?.obsTime != null) d = new Date(Number(item.obsTime) * 1000);
    if (!d || isNaN(d.getTime())) return "--Z";
    return `${pad2(d.getUTCDate())}${pad2(d.getUTCHours())}${pad2(d.getUTCMinutes())}Z`;
  }

  function mkRow(station){
    const tr = document.createElement("tr");
    tr.id = `row_${station}`;
    tr.innerHTML = `
      <td class="col-sta">
        <div class="sta">${station}</div>
        <div class="muted" id="obs_${station}" style="margin-top:3px;font-size:11px;">--Z</div>
      </td>

      <td class="col-ctr" id="ctr_${station}">
        <span class="ctrlabel">CTR:</span>
        <span class="ctroff">OFF</span>
      </td>

      <td class="col-rwy" id="rwy_${station}">RWY --</td>
      <td class="col-qnh" id="qnh_${station}">--</td>
      <td class="col-wind" id="wind_${station}">----</td>
      <td class="col-vis" id="vis_${station}">--</td>
      <td class="col-met"><div class="metar" id="metar_${station}">Loading…</div></td>
    `;
    return tr;
  }

  function ensureRows(){
    tbody.innerHTML = "";
    for (const s of STATIONS) tbody.appendChild(mkRow(s));
  }

  function applyRow(station, item){
    const raw = (item?.rawOb ?? "") || "";
    document.getElementById(`obs_${station}`).textContent = obsZFromItem(item);
    document.getElementById(`qnh_${station}`).textContent = fmtQnh(item);
    document.getElementById(`wind_${station}`).textContent = fmtWind(item);
    document.getElementById(`vis_${station}`).textContent = fmtVis(item);

    const met = document.getElementById(`metar_${station}`);
    const prev = state.lastRaw.get(station);
    met.classList.remove("changed","new");
    if (!prev && raw) met.classList.add("new");
    else if (prev && raw && prev !== raw) met.classList.add("changed");
    met.textContent = raw || "No METAR returned.";
    state.lastRaw.set(station, raw);
  }

  function setCtrCell(icao, online){
    const el = document.getElementById(`ctr_${icao}`);
    if (!el) return;
    el.innerHTML = online
      ? `<span class="ctrlabel">CTR:</span> <span class="ctractive">Active</span>`
      : `<span class="ctrlabel">CTR:</span> <span class="ctroff">OFF</span>`;
  }

  async function fetchOnlineCtr(){
    try{
      const res = await fetch(`${API_BASE}/vatsim?_=${Date.now()}`, { cache: "no-store" });
      if (!res.ok) return;

      const data = await res.json();
      const controllers = Array.isArray(data?.controllers) ? data.controllers : [];

      const online = new Set();
      for (const c of controllers) {
        const cs = String(c?.callsign || "").toUpperCase().trim();
        const m = cs.match(/^([A-Z]{4})_CTR\b/);
        if (m) online.add(m[1]);
      }

      for (const s of STATIONS) setCtrCell(s, online.has(s));
    } catch {}
  }

  async function fetchAtisRunways(){
    try{
      const res = await fetch(`${API_BASE}/vatsim?_=${Date.now()}`, { cache: "no-store" });
      if (!res.ok) return;

      const data = await res.json();
      const atisArr = Array.isArray(data?.atis) ? data.atis : [];
      const atisByIcao = new Map();

      for (const a of atisArr) {
        const cs = String(a?.callsign || "").toUpperCase();
        const m = cs.match(/^([A-Z]{4})_.*ATIS$/);
        if (!m) continue;

        const icao = m[1];
        const lines = Array.isArray(a?.text_atis) ? a.text_atis : [];
        const text = lines.join(" ").trim();
        if (!text) continue;

        const prev = atisByIcao.get(icao);
        if (!prev || text.length > prev.text.length) atisByIcao.set(icao, { lines, text });
      }

      for (const s of STATIONS) {
        const cell = document.getElementById(`rwy_${s}`);
        if (!cell) continue;
        const atis = atisByIcao.get(s);
        if (!atis) { cell.textContent = "RWY --"; continue; }
        const r = extractRunwaysFromAtis(atis.lines);
        cell.textContent = formatRunwayDisplay(r) || "RWY --";
      }
    } catch {}
  }

  async function fetchMetars(){
    clearError();
    setStatus("FETCH");
    refreshBtn.disabled = true;

    try{
      const ids = encodeURIComponent(STATIONS.join(","));
      const url = `${API_BASE}/?ids=${ids}&format=json&_=${Date.now()}`;

      const res = await fetch(url, { headers: { "Accept": "application/json" }, cache: "no-store" });
      if (res.status === 204) throw new Error("No data returned (HTTP 204).");
      if (!res.ok){
        const t = await res.text();
        throw new Error(`Request failed (HTTP ${res.status}).\n\n${t.slice(0,900)}`);
      }

      const data = await res.json();
      if (!Array.isArray(data)) throw new Error("Unexpected JSON shape (expected array).");

      const byStation = new Map();
      for (const item of data){
        const sid = item?.icaoId ? String(item.icaoId).toUpperCase().trim() : null;
        if (sid) byStation.set(sid, item);
      }

      for (const s of STATIONS){
        const item = byStation.get(s);
        if (!item){
          // ✅ no temp_ access anymore (it doesn't exist)
          document.getElementById(`obs_${s}`).textContent = "--Z";
          document.getElementById(`qnh_${s}`).textContent = "--";
          document.getElementById(`wind_${s}`).textContent = "----";
          document.getElementById(`vis_${s}`).textContent = "--";
          document.getElementById(`metar_${s}`).textContent = "— no station in response —";
          state.lastRaw.set(s, "");
        } else {
          applyRow(s, item);
        }
      }

      setStatus("OK");
    } catch(e){
      setStatus("ERR");
      showError(String(e?.message || e));
    } finally {
      refreshBtn.disabled = false;
    }
  }

  function stopTimer(){
    if (state.timer) clearInterval(state.timer);
    state.timer = null;
  }

  function startTimer(){
    stopTimer();
    if (!autoToggle.checked) return;
    const secs = Number(refreshSelect.value) || 60;
    state.timer = setInterval(() => {
      fetchMetars();
      fetchAtisRunways();
      fetchOnlineCtr();
    }, secs * 1000);
  }

  function setPreset(key){
    STATIONS = [...(STATION_PRESETS[key] || STATION_PRESETS.EBG_NORD)];
    state.lastRaw = new Map();
    ensureRows();
    fetchMetars();
    fetchAtisRunways();
    fetchOnlineCtr();
    startTimer();
  }

  // UI hooks
  refreshBtn.addEventListener("click", () => {
    fetchMetars();
    fetchAtisRunways();
    fetchOnlineCtr();
  });
  autoToggle.addEventListener("change", startTimer);
  refreshSelect.addEventListener("change", startTimer);

  // ✅ preset dropdown hook (now presetSelect exists)
  presetSelect.addEventListener("change", () => {
    localStorage.setItem("preset", presetSelect.value);
    setPreset(presetSelect.value);
  });

  // Initial load
  const saved = localStorage.getItem("preset") || "EBG_NORD";
  presetSelect.value = saved;
  setPreset(saved);
</script>

</body>
</html>
