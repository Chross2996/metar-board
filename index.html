<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>METAR SUED Board</title>
<style>
  :root{
    color-scheme: dark;
    --bg:#062a8a;          /* deep ATC blue */
    --panel:#041f66;
    --panel2:#0733a5;
    --line:#b9d3ff;
    --text:#eaf2ff;
    --cyan:#80d7ff;
    --yellow:#ffe26b;
    --red:#ff5c5c;
    --green:#3dff9a;
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    padding:18px;
    background: linear-gradient(180deg, #0733a5 0%, #062a8a 55%, #041f66 100%);
    color:var(--text);
    font-family:var(--sans);
  }

  .frame{
    border: 2px solid var(--line);
    background: rgba(0,0,0,.06);
    box-shadow: 0 16px 60px rgba(0,0,0,.35);
  }

  .topbar{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding:10px 12px;
    border-bottom: 2px solid var(--line);
    background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.02));
  }

  .title{
    font-family:var(--mono);
    font-weight:700;
    letter-spacing:.8px;
    font-size:18px;
    color:var(--yellow);
    text-transform:uppercase;
  }

  .rightInfo{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
    justify-content:flex-end;
    font-family:var(--mono);
    font-size:12px;
    color:var(--cyan);
  }

  .pill{
    border: 1px solid var(--line);
    padding:6px 8px;
    border-radius:3px;
    background: rgba(0,0,0,.10);
    white-space:nowrap;
  }

  .controls{
    display:flex;
    gap:8px;
    align-items:center;
    flex-wrap:wrap;
  }

  select, button, input[type="checkbox"]{
    font-family:var(--mono);
    font-size:12px;
  }
  select, button{
    border:1px solid var(--line);
    background: rgba(0,0,0,.10);
    color:var(--text);
    padding:6px 8px;
    border-radius:3px;
    outline:none;
  }
  button:hover{ background: rgba(255,255,255,.08); cursor:pointer; }
  button:disabled{ opacity:.55; cursor:not-allowed; }
  label{
    display:inline-flex;
    gap:6px;
    align-items:center;
    user-select:none;
  }

  .error{
    display:none;
    padding:10px 12px;
    border-bottom: 2px solid var(--line);
    background: rgba(255,92,92,.10);
    color: var(--text);
    font-family: var(--mono);
    font-size: 12px;
    white-space: pre-wrap;
  }

  /* Table-like board */
  .board{
    width:100%;
    border-collapse: collapse;
    table-layout: fixed;
    font-family: var(--mono);
    font-size: 13px;
  }
  .board th, .board td{
    border-bottom: 1px solid rgba(185,211,255,.55);
    padding: 8px 10px;
    vertical-align: top;
  }
  .board thead th{
    border-bottom: 2px solid var(--line);
    background: rgba(0,0,0,.12);
    color: var(--cyan);
    font-weight: 700;
    letter-spacing: .4px;
    text-transform: uppercase;
    font-size: 12px;
  }

  .col-sta{ width: 90px; }
  .col-qnh{ width: 92px; }
  .col-temp{ width: 92px; }
  .col-wind{ width: 110px; }
  .col-vis{ width: 90px; }
  .col-met{ width: auto; }

  .sta{
    color: var(--cyan);
    font-weight: 800;
    letter-spacing: 1px;
  }
  .muted{ color: rgba(234,242,255,.75); }
  .metar{
    white-space: pre-wrap;
    word-break: break-word;
    line-height: 1.25;
  }
  .changed{ color: var(--red); }
  .new{ color: var(--green); }

  .foot{
    padding:10px 12px;
    border-top: 2px solid var(--line);
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    justify-content:space-between;
    align-items:center;
    background: rgba(0,0,0,.10);
    font-family:var(--mono);
    font-size:12px;
    color: rgba(234,242,255,.78);
  }
</style>
</head>
<body>

<div class="frame">
  <div class="topbar">
    <div>
      <div class="title">METAR and AD-Info — EMS / DST / HRZ</div>
      <div class="muted" style="font-family:var(--mono); font-size:12px; margin-top:2px;">
        ATC-style board • auto-refresh
      </div>
    </div>

    <div class="rightInfo">
      <div class="pill" id="statusPill">STATUS: <span id="statusText">IDLE</span></div>
      <div class="pill" id="timePill">UTC: <span id="utcClock">--:--:--</span></div>
      <div class="controls">
        <label class="pill">
          <input type="checkbox" id="autoToggle" checked />
          AUTO
        </label>
        <select id="refreshSelect" class="pill" title="Refresh interval">
          <option value="30">30s</option>
          <option value="60" selected>60s</option>
          <option value="120">2m</option>
          <option value="300">5m</option>
        </select>
        <button id="refreshBtn" class="pill">REFRESH</button>
      </div>
    </div>
  </div>

  <div class="error" id="errorBox"></div>

  <table class="board">
    <thead>
      <tr>
        <th class="col-sta">STN</th>
        <th class="col-qnh">QNH</th>
        <th class="col-temp">T/D</th>
        <th class="col-wind">WIND</th>
        <th class="col-vis">VIS</th>
        <th class="col-met">METAR</th>
      </tr>
    </thead>
    <tbody id="tbody">
      <!-- rows injected -->
    </tbody>
  </table>

  <div class="foot">
    <div>Source: aviationweather.gov Data API → <span class="muted">/api/data/metar?ids=...&format=json</span></div>
    <div>Tip: If browser blocks requests on file://, run <span class="muted">python -m http.server</span></div>
  </div>
</div>

<script>
  // Stations you asked for
  const STATIONS = ["EDDH","EDHI","EDHL","EDDW","EDXW","EDDV","ETNS","ETNH","ETMN","ETNT"];
  const API_BASE = "https://aviationweather.gov/api/data/metar";

  const refreshBtn = document.getElementById("refreshBtn");
  const autoToggle = document.getElementById("autoToggle");
  const refreshSelect = document.getElementById("refreshSelect");
  const statusText = document.getElementById("statusText");
  const errorBox = document.getElementById("errorBox");
  const tbody = document.getElementById("tbody");

  const state = {
    timer: null,
    lastRaw: new Map(), // station -> raw_text
    lastFetchAt: null,
  };

  function pad2(n){ return String(n).padStart(2,"0"); }
  function setUtcClock(){
    const d = new Date();
    const s = `${pad2(d.getUTCHours())}:${pad2(d.getUTCMinutes())}:${pad2(d.getUTCSeconds())}`;
    document.getElementById("utcClock").textContent = s;
  }
  setInterval(setUtcClock, 500);
  setUtcClock();

  function setStatus(txt){ statusText.textContent = txt; }
  function showError(msg){
    errorBox.style.display = "block";
    errorBox.textContent = msg;
  }
  function clearError(){
    errorBox.style.display = "none";
    errorBox.textContent = "";
  }

  function fmtQnh(item){
    // API often returns altim_in_hg; some also return sea_level_pressure_mb or altim.
    const mb = item.sea_level_pressure_mb ?? item.slp_mb ?? item.slp ?? null;
    if (mb) return `Q${Math.round(Number(mb))}`;
    const inhg = item.altim_in_hg ?? item.altim ?? null;
    if (!inhg) return "--";
    // Convert inHg to hPa, typical: 29.92 -> 1013
    const hpa = Math.round(Number(inhg) * 33.8639);
    return `Q${hpa}`;
  }

  function fmtTemp(item){
    const t = item.temp_c ?? item.tempC ?? null;
    const d = item.dewpoint_c ?? item.dewpointC ?? item.dew_c ?? null;
    if (t == null && d == null) return "--/--";
    const tt = (t == null) ? "--" : Math.round(Number(t));
    const dd = (d == null) ? "--" : Math.round(Number(d));
    return `${tt}/${dd}`;
  }

  function fmtWind(item){
    const dir = item.wind_dir_degrees ?? item.wind_dir ?? item.wdir ?? null;
    const spd = item.wind_speed_kt ?? item.wind_speed ?? item.wspd ?? null;
    const gst = item.wind_gust_kt ?? item.wind_gust ?? null;
    if (dir == null && spd == null) return "----";
    const d = (dir == null) ? "///" : String(Math.round(Number(dir))).padStart(3,"0");
    const s = (spd == null) ? "//" : String(Math.round(Number(spd))).padStart(2,"0");
    const g = (gst == null) ? "" : `G${String(Math.round(Number(gst))).padStart(2,"0")}`;
    return `${d}${s}${g}`;
  }

  function fmtVis(item){
    // API fields vary; use visibility_statute_mi if present, else raw
    const v = item.visibility_statute_mi ?? item.vis_mi ?? item.visibility ?? null;
    if (v == null) return "--";
    const n = Number(v);
    if (!isNaN(n)) {
      if (n >= 6) return "9999+";
      return `${n.toFixed(0)}SM`;
    }
    return String(v).slice(0,6);
  }

  function mkRow(station){
    const tr = document.createElement("tr");
    tr.id = `row_${station}`;
    tr.innerHTML = `
      <td class="col-sta"><div class="sta">${station}</div><div class="muted" id="obs_${station}" style="margin-top:3px;font-size:11px;">--Z</div></td>
      <td class="col-qnh" id="qnh_${station}">--</td>
      <td class="col-temp" id="temp_${station}">--/--</td>
      <td class="col-wind" id="wind_${station}">----</td>
      <td class="col-vis" id="vis_${station}">--</td>
      <td class="col-met"><div class="metar" id="metar_${station}">Loading…</div></td>
    `;
    return tr;
  }

  function ensureRows(){
    tbody.innerHTML = "";
    for (const s of STATIONS) tbody.appendChild(mkRow(s));
  }

  function obsZ(iso){
    if (!iso) return "--Z";
    const d = new Date(iso);
    if (isNaN(d.getTime())) return "--Z";
    return `${pad2(d.getUTCDate())}${pad2(d.getUTCHours())}${pad2(d.getUTCMinutes())}Z`;
  }

  function applyRow(station, item){
    const raw = (item?.raw_text ?? item?.rawText ?? item?.raw ?? item?.metar ?? "") || "";
    const obs = item?.observation_time ?? item?.observationTime ?? item?.time ?? item?.issue_time ?? "";

    document.getElementById(`obs_${station}`).textContent = obsZ(obs);
    document.getElementById(`qnh_${station}`).textContent = fmtQnh(item ?? {});
    document.getElementById(`temp_${station}`).textContent = fmtTemp(item ?? {});
    document.getElementById(`wind_${station}`).textContent = fmtWind(item ?? {});
    document.getElementById(`vis_${station}`).textContent = fmtVis(item ?? {});

    const met = document.getElementById(`metar_${station}`);
    const prev = state.lastRaw.get(station);

    met.classList.remove("changed","new");

    if (!prev && raw) met.classList.add("new");
    else if (prev && raw && prev !== raw) met.classList.add("changed");

    met.textContent = raw || "No METAR returned.";
    state.lastRaw.set(station, raw);
  }

  async function fetchMetars(){
    clearError();
    setStatus("FETCH");
    refreshBtn.disabled = true;

    try{
      const ids = encodeURIComponent(STATIONS.join(","));
      const url = `${API_BASE}?ids=${ids}&format=json&_=${Date.now()}`;

      const res = await fetch(url, { headers: { "Accept": "application/json" }, cache: "no-store" });

      if (res.status === 204) throw new Error("No data returned (HTTP 204).");
      if (!res.ok){
        const t = await res.text();
        throw new Error(`Request failed (HTTP ${res.status}).\n\n${t.slice(0,900)}`);
      }

      const data = await res.json();
      if (!Array.isArray(data)) throw new Error("Unexpected JSON shape (expected array).");

      const byStation = new Map();
      for (const item of data){
        const sid = item.station_id || item.stationId || item.icao || item.id;
        if (!sid) continue;
        byStation.set(String(sid).toUpperCase(), item);
      }

      for (const s of STATIONS){
        const item = byStation.get(s);
        if (!item){
          applyRow(s, { raw_text: "— no station in response —" });
          document.getElementById(`obs_${s}`).textContent = "--Z";
          document.getElementById(`qnh_${s}`).textContent = "--";
          document.getElementById(`temp_${s}`).textContent = "--/--";
          document.getElementById(`wind_${s}`).textContent = "----";
          document.getElementById(`vis_${s}`).textContent = "--";
        } else {
          applyRow(s, item);
        }
      }

      setStatus("OK");
      state.lastFetchAt = new Date();
    } catch(e){
      setStatus("ERR");
      showError(String(e?.message || e));
    } finally {
      refreshBtn.disabled = false;
    }
  }

  function startTimer(){
    stopTimer();
    if (!autoToggle.checked) return;
    const secs = Number(refreshSelect.value) || 60;
    state.timer = setInterval(fetchMetars, secs * 1000);
  }
  function stopTimer(){
    if (state.timer) clearInterval(state.timer);
    state.timer = null;
  }

  refreshBtn.addEventListener("click", fetchMetars);
  autoToggle.addEventListener("change", startTimer);
  refreshSelect.addEventListener("change", startTimer);

  ensureRows();
  fetchMetars();
  startTimer();
</script>

</body>
</html>
